from pathlib import Path

from defi_risk_analyzer.evaluation.exploit_test import (
    evaluate_exploit_contract,
    generate_exploit_report,
    load_expected_flags,
)


def test_exploit_evaluation_detects_expected_flags() -> None:
    # Fixture-based evaluation against a known vulnerable pattern.
    base = Path(__file__).parent / "fixtures"
    source_code = (base / "reentrancy_vault.sol").read_text(encoding="utf-8")
    expected = load_expected_flags(base / "reentrancy_expected.json")

    result = evaluate_exploit_contract(source_code, expected)
    report = generate_exploit_report(result)

    assert "reentrancy" in report
    assert "unsafe_external_calls" in report
    assert "Missed expected issues" in report
